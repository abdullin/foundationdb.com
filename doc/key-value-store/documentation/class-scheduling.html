<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
<head>


<script type="text/javascript" src="/static/js/analytics.js"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app15.us.archive.org";archive_analytics.values.server_ms=87;</script>
<link type="text/css" rel="stylesheet" href="/static/css/banner-styles.css"/>


<title>

Class Scheduling

&mdash; FoundationDB
</title>
<meta charset='utf-8'>
<meta content=' foundationdb, database, nosql, scalable, fault tolerant, acid, transactions' name='keywords'>
<meta content='FoundationDB is a database that combines NoSQL scalability with true multikey ACID transactions.' name='description'>
<meta content='FoundationDB' name='author'>
<meta content='IE=edge' http-equiv='x-ua-compatible'>
<meta content='173350679' property='twitter:account_id'>
<meta content='FoundationDB' property='og:title'>
<meta content='https://foundationdb.com' property='og:url'>
<meta content='https://foundationdb.com/images/stacks.png' property='og:image'>
<meta content='FoundationDB is a database that combines NoSQL scalability with true multikey ACID transactions.' name='og:description'>
<meta content='2j_g9LCoS3SGSPULb2MLPGk2raKkFd4hPOuWWM5AsVw' name='google-site-verification'>
<link href='https://foundationdb.com/key-value-store/documentation/class-scheduling.html' rel='canonical'>
<!--[if lt IE 9]>
<script src='/web/20150325003227/https://html5shiv.googlecode.com/svn/trunk/html5.js'></script>
<![endif]-->
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<link href=../../im_/favicon-eea8382cf5c35e23f9fb4273c134b2c0.png rel="shortcut icon" type="image/png" />
<meta content="authenticity_token" name="csrf-param" />
<meta content="1Ya+121dxZCK07uT6mMrgegHXF6ABDCjHdLyA9XrLNY=" name="csrf-token" />
<link href=../../cs_/google.css media="screen" rel="stylesheet" type="text/css" />
<link href=../../cs_/application-5cc81fa97aedacb1157cce0e30895a04.css media="all" rel="stylesheet" type="text/css" />

</head>
<body class='show' id='documentation'>



<header id='header'>
<div class='container'>
<a href='/web/20150325003227/https://foundationdb.com/' id='logo'></a>
<a id='mobile-nav-toggle'><img alt="Hamburger" src=../../im_/hamburger-bbd9560947385da4445b540086f10c9b.png /></a>
<a id='mobile-auth-toggle'>
<i class='icon-user'></i>
</a>
<div id='auth-links'></div>
</div>
</header>
<nav id='nav'>
<div class='container'>
<ul>
<li class=''>
<a href=../../index.html><span>H</span>ome</a>
</li>
<li class='active with-subnav'>
<a href=../index.html><span>K</span>ey-Value Store</a>
<ul class='subnav'>
<li><a href=../index.html>Overview</a></li>
<li><a href=index.html>Documentation</a></li>
<li><a href=../performance/index.html>Performance</a></li>
</ul>
</li>
<li class='with-subnav'>
<a href=../../layers/sql/index.html><span>S</span>QL Layer</a>
<ul class='subnav'>
<li><a href=../../layers/sql/index.html>Overview</a></li>
<li><a href=../../layers/sql/documentation/index.html>Documentation</a></li>
<li><a href=../../layers/sql/performance/index.html>Performance</a></li>
</ul>
</li>
<li class='with-subnav'>
<a href=../../community/index.html><span>R</span>esources</a>
<ul class='subnav'>
<li><a href=../../https:/web.archive.org/web/20150325003227/http:/community.foundationdb.com>Community</a></li>
<li><a href=../../https:/web.archive.org/web/20150325003227/https:/foundationdb.com/courses>Education</a></li>
<li><a href=../../videos/index.html>Videos</a></li>
</ul>
</li>
<li class='with-subnav'>
<a href=../../about/index.html><span>C</span>ompany</a>
<ul class='subnav'>
<li><a href=../../about/index.html>About Us</a></li>
<li><a href=../../contact/index.html>Contact Us</a></li>
<li><a href=../../jobs/index.html>Jobs</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<div id='flash'>
<div class='notice'></div>
<div class='alert'></div>
</div>
<div id='documentation-inner'>
<div id='docs-global-nav-content'>
<ul>
<li><a href=index.html>Summary</a></li>
<li><a href=index.html>Getting Started</a></li>
<li><a href=tutorials.html>Tutorials</a></li>
<li><a href=developer-guide.html>Developer Guide</a></li>
<li><a href=data-modeling.html>Data Modeling</a></li>
<li><a href=../recipes/index.html>Design Recipes</a></li>
<li>
<a href=api-reference.html>API Reference</a>
<ul>
<li><a href=api-python.html>Python API</a></li>
<li><a href=api-ruby.html>Ruby API</a></li>
<li><a href=api-node.html>Node.js API</a></li>
<li><a href=api-php.html>PHP API</a></li>
<li><a href=../../https:/web.archive.org/web/20150325003227/https:/foundationdb.com/key-value-store/documentation/javadoc/index.html>Java API</a></li>
<li><a href=../../https:/web.archive.org/web/20150325003227/http:/godoc.org/github.com/FoundationDB/fdb-go/fdb>Go API</a></li>
<li><a href=../../https:/web.archive.org/web/20150325003227/https:/github.com/Doxense/foundationdb-dotnet-client>.NET API</a></li>
<li><a href=api-c.html>C API</a></li>
</ul>
</li>
<li><a href=building-cluster.html>Building a Cluster</a></li>
<li><a href=configuration.html>Configuration</a></li>
<li><a href=administration.html>Administration</a></li>
<li><a href=command-line-interface.html>Command Line Interface</a></li>
<li><a href=mr-status.html>Machine-Readable Status</a></li>
<li><a href=tls.html>Transport Layer Security</a></li>
<li><a href=backups.html>Backup and Restoration</a></li>
<li><a href=known-limitations.html>Known Limitations</a></li>
<li><a href=platforms.html>Platform Issues</a></li>
<li><a href=release-notes.html>Release Notes</a></li>
<li><a href=older/index.html>Older Versions</a></li>
<li><a href=../white-papers/index.html>White Papers</a></li>
</ul>
</div>

<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
  	URL_ROOT:    '',
  	VERSION:     '3.0.7',
  	COLLAPSE_INDEX: false,
  	FILE_SUFFIX: '.html',
  	HAS_SOURCE:  true
  };
</script>

<div id="breadcrumbs" class="container">
  <div id="breadcrumbs-inner">
    
    <a href="index.html">FoundationDB 3.0</a> &raquo;
    <a href="tutorials.html">Tutorials</a> &raquo;
    
    <a id="mobile-search-link" href=search.html>
      <img alt="Magnifying-glass" src=../../im_/magnifying-glass-1e869de9fc6b47eca22fbd10a9d914a3.png />
    </a>
  </div>
</div>
<div id="documentation" class="container">
  <div class="body sphinx">
    
  <div class="section" id="class-scheduling">
<h1>Class Scheduling<a class="headerlink" href="#class-scheduling" title="Permalink to this headline">∞</a></h1>
<p>This tutorial provides a walkthrough of designing and building a simple application in Python using FoundationDB. In this tutorial, we use a few simple data modeling techniques. For a more in-depth discussion of data modeling in FoundationDB, see <a class="reference internal" href="data-modeling.html"><em>Data Modeling</em></a>.</p>
<p>The concepts in this tutorial are applicable to all the <a class="reference internal" href="api-reference.html"><em>languages</em></a> supported by FoundationDB. If you prefer, you can see a version of this tutorial in:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="class-scheduling-ruby.html">Ruby</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="class-scheduling-java.html">Java</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="class-scheduling-go.html">Go</a><ul class="simple">
</ul>
</li>
</ul>
</div>
<div class="section" id="first-steps">
<span id="tutorial-first-steps"></span><h2>First steps<a class="headerlink" href="#first-steps" title="Permalink to this headline">∞</a></h2>
<p>Let&#8217;s begin with &#8220;Hello world.&#8221;</p>
<p>If you have not yet installed FoundationDB, see <a class="reference internal" href="getting-started.html"><em>Getting Started</em></a>.</p>
<p>Open a Python interactive interpreter and import the FoundationDB API module:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python
&gt;&gt;&gt; import fdb
</pre></div>
</div>
<p>Before using the API, we need to specify the API version. This allows programs to maintain compatibility even if the API is modified in future versions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">fdb</span><span class="o">.</span><span class="n">api_version</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we open a FoundationDB database.  The API will connect to the FoundationDB cluster indicated by the <a class="reference internal" href="administration.html#default-cluster-file"><em>default cluster file</em></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<p>We are ready to use the database. In Python, using the <tt class="docutils literal"><span class="pre">[]</span></tt> operator on the db object is a convenient syntax for performing a read or write on the database. First, let&#8217;s simply write a key-value pair:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;world&#39;</span>
</pre></div>
</div>
<p>When this command returns without exception, the modification is durably stored in FoundationDB! Under the covers, this function creates a transaction with a single modification. We&#8217;ll see later how to do multiple operations in a single transaction. For now, let&#8217;s read back the data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span>
<span class="go">hello world</span>
</pre></div>
</div>
<p>If this is all working, it looks like we are ready to start building a real application. For reference, here&#8217;s the full code for &#8220;hello world&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">fdb</span>
<span class="n">fdb</span><span class="o">.</span><span class="n">api_version</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">db</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;world&#39;</span>
<span class="k">print</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="class-scheduling-application">
<h2>Class scheduling application<a class="headerlink" href="#class-scheduling-application" title="Permalink to this headline">∞</a></h2>
<p>Let&#8217;s say we&#8217;ve been asked to build a class scheduling system for students and administrators. We&#8217;ll walk through the design and implementation of this application. Instead of typing everything in as you follow along, look at the <a class="reference internal" href="#tutorial-appendix"><em>Appendix: SchedulingTutorial.py</em></a> for a finished version of the program. You may want to refer to this code as we walk through the tutorial.</p>
<div class="section" id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">∞</a></h3>
<p>We&#8217;ll need to let users list available classes and track which students have signed up for which classes. Here&#8217;s a first cut at the functions we&#8217;ll need to implement:</p>
<div class="highlight-python"><div class="highlight"><pre>available_classes()      # returns list of classes
signup(studentID, class) # signs up a student for a class
drop(studentID, class)   # drops a student from a class
</pre></div>
</div>
</div>
<div class="section" id="data-model">
<span id="tutorial-data-model"></span><h3>Data model<a class="headerlink" href="#data-model" title="Permalink to this headline">∞</a></h3>
<p>First, we need to design a <a class="reference internal" href="data-modeling.html"><em>data model</em></a>. A data model is just a method for storing our application data using keys and values in FoundationDB. We seem to have two main types of data: (1) a list of classes and (2) a record of which students will attend which classes. Let&#8217;s keep attending data like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># (&#39;attends&#39;, student, class) = &#39;&#39;</span>
</pre></div>
</div>
<p>We&#8217;ll just store the key with a blank value to indicate that a student is signed up for a particular class. For this application, we&#8217;re going to think about a key-value pair&#8217;s key as a <a class="reference internal" href="data-modeling.html#data-modeling-tuples"><em>tuple</em></a>. Encoding a tuple of data elements into a key is a very common pattern for an ordered key-value store.</p>
<p>We&#8217;ll keep data about classes like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># (&#39;class&#39;, class_name) = seats_available</span>
</pre></div>
</div>
<p>Similarly, each such key will represent an available class. We&#8217;ll use <tt class="docutils literal"><span class="pre">seats_available</span></tt> to record the number of seats available.</p>
</div>
<div class="section" id="directories-and-subspaces">
<h3>Directories and Subspaces<a class="headerlink" href="#directories-and-subspaces" title="Permalink to this headline">∞</a></h3>
<p>FoundationDB includes a few tools that make it easy to model data using this approach. Let&#8217;s begin by
opening a <a class="reference internal" href="developer-guide.html#developer-guide-directories"><em>directory</em></a> in the database:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">fdb</span>
<span class="n">fdb</span><span class="o">.</span><span class="n">api_version</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">scheduling</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">directory</span><span class="o">.</span><span class="n">create_or_open</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;scheduling&#39;</span><span class="p">,))</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">create_or_open()</span></tt> method returns a <a class="reference internal" href="developer-guide.html#developer-guide-sub-keyspaces"><em>subspace</em></a> where we&#8217;ll store our application data. Each subspace has a fixed prefix it uses when defining keys. The prefix corresponds to the first element of a tuple. We decided that we wanted <tt class="docutils literal"><span class="pre">'attends'</span></tt> and  <tt class="docutils literal"><span class="pre">'class'</span></tt> as our prefixes, so we&#8217;ll create new subspaces for them within the <tt class="docutils literal"><span class="pre">scheduling</span></tt> subspace.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">course</span> <span class="o">=</span> <span class="n">scheduling</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span>
<span class="n">attends</span> <span class="o">=</span> <span class="n">scheduling</span><span class="p">[</span><span class="s">&#39;attends&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Subspaces have a <tt class="xref py py-meth docutils literal"><span class="pre">pack()</span></tt> method for defining keys. To store the records for our data model, we can use <tt class="docutils literal"><span class="pre">attends.pack((s,</span> <span class="pre">c))</span></tt> and <tt class="docutils literal"><span class="pre">course.pack((c,))</span></tt>.</p>
</div>
<div class="section" id="transactions">
<h3>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">∞</a></h3>
<p>We&#8217;re going to rely on the powerful guarantees of transactions to help keep all of our modifications straight, so let&#8217;s look at a nice way that the FoundationDB Python API lets you write a transactional function. By using a decorator, an entire function is wrapped in a transaction. Let&#8217;s write the very simple <tt class="docutils literal"><span class="pre">add_class</span></tt> function we will use to populate the database&#8217;s class list:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">add_class</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="api-python.html#fdb.transactional" title="fdb.transactional"><tt class="xref py py-func docutils literal"><span class="pre">&#64;fdb.transactional</span></tt></a> is a Python decorator that makes a normal function a transactional function. All functions decorated this way <em>need to have a parameter named</em> <tt class="docutils literal"><span class="pre">tr</span></tt>. This parameter is passed the transaction that the function should use to do reads and writes.</p>
<p>When <em>calling</em> a transactionally decorated function, however, you can pass a database instead of a transaction for the <tt class="docutils literal"><span class="pre">tr</span></tt> parameter. The decorator <em>automatically creates a transaction and implements a retry loop</em> to ensure that the transaction eventually commits.</p>
<p>For a FoundationDB database <tt class="docutils literal"><span class="pre">db</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">add_class</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;class1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_transaction</span><span class="p">()</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">add_class</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="s">&#39;class1&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="n">fdb</span><span class="o">.</span><span class="n">FDBError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>If instead you pass a <tt class="xref py py-class docutils literal"><span class="pre">Transaction</span></tt> for the <tt class="docutils literal"><span class="pre">tr</span></tt> parameter, the transaction will be used directly, and it is assumed that the caller implements appropriate retry logic for errors. This permits transactionally decorated functions to be composed into larger transactions.</p>
</div>
<div class="section" id="making-some-sample-classes">
<h3>Making some sample classes<a class="headerlink" href="#making-some-sample-classes" title="Permalink to this headline">∞</a></h3>
<p>Let&#8217;s make some sample classes and put them in the <tt class="docutils literal"><span class="pre">class_names</span></tt> variable. The Python <tt class="docutils literal"><span class="pre">itertools</span></tt> module is used to make individual classes from combinations of class types, levels, and times:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>

<span class="c"># Generate 1,620 classes like &#39;9:00 chem for dummies&#39;</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;intro&#39;</span><span class="p">,</span> <span class="s">&#39;for dummies&#39;</span><span class="p">,</span> <span class="s">&#39;remedial&#39;</span><span class="p">,</span> <span class="s">&#39;101&#39;</span><span class="p">,</span>
          <span class="s">&#39;201&#39;</span><span class="p">,</span> <span class="s">&#39;301&#39;</span><span class="p">,</span> <span class="s">&#39;mastery&#39;</span><span class="p">,</span> <span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;seminar&#39;</span><span class="p">]</span>
<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;chem&#39;</span><span class="p">,</span> <span class="s">&#39;bio&#39;</span><span class="p">,</span> <span class="s">&#39;cs&#39;</span><span class="p">,</span> <span class="s">&#39;geometry&#39;</span><span class="p">,</span> <span class="s">&#39;calc&#39;</span><span class="p">,</span>
         <span class="s">&#39;alg&#39;</span><span class="p">,</span> <span class="s">&#39;film&#39;</span><span class="p">,</span> <span class="s">&#39;music&#39;</span><span class="p">,</span> <span class="s">&#39;art&#39;</span><span class="p">,</span> <span class="s">&#39;dance&#39;</span><span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:00&#39;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>
<span class="n">class_combos</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">class_combos</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-the-database">
<h3>Initializing the database<a class="headerlink" href="#initializing-the-database" title="Permalink to this headline">∞</a></h3>
<p>We initialize the database with our class list:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">scheduling</span><span class="o">.</span><span class="n">range</span><span class="p">(())]</span>  <span class="c"># Clear the directory</span>
    <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
        <span class="n">add_class</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</pre></div>
</div>
<p>After <tt class="xref py py-func docutils literal"><span class="pre">init()</span></tt> is run, the database will contain all of the sample classes we created above.</p>
</div>
<div class="section" id="listing-available-classes">
<h3>Listing available classes<a class="headerlink" href="#listing-available-classes" title="Permalink to this headline">∞</a></h3>
<p>Before students can do anything else, they need to be able to retrieve a list of available classes from the database. Because FoundationDB sorts its data by key and therefore has efficient range-read capability, we can retrieve all of the classes in a single database call. We find this range of keys with <tt class="xref py py-meth docutils literal"><span class="pre">course.range()</span></tt>.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">available_classes</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">range</span><span class="p">(())]]</span>
</pre></div>
</div>
<p>In general, the <tt class="xref py py-meth docutils literal"><span class="pre">Subspace.range()</span></tt> method returns a Python <tt class="docutils literal"><span class="pre">slice</span></tt> representing all the key-value pairs starting with the specified tuple. In this case, we want all classes, so we call <tt class="xref py py-meth docutils literal"><span class="pre">course.range()</span></tt> with the empty tuple <tt class="docutils literal"><span class="pre">()</span></tt>. FoundationDB&#8217;s <tt class="docutils literal"><span class="pre">tr[slice]</span></tt> function returns an iterable list of key-values in the range specified by the slice. We unpack the key <tt class="docutils literal"><span class="pre">k</span></tt> and value <tt class="docutils literal"><span class="pre">v</span></tt> in a comprehension. To extract the class name itself, we unpack the key into a tuple using the <a class="reference internal" href="api-python.html#module-fdb.tuple" title="fdb.tuple"><tt class="xref py py-mod docutils literal"><span class="pre">fdb.tuple</span></tt></a> module and take its third part. (The first and second parts are the prefixes for the <tt class="docutils literal"><span class="pre">scheduling</span></tt> and <tt class="docutils literal"><span class="pre">course</span></tt> subspaces, respectively.)</p>
</div>
<div class="section" id="signing-up-for-a-class">
<h3>Signing up for a class<a class="headerlink" href="#signing-up-for-a-class" title="Permalink to this headline">∞</a></h3>
<p>We finally get to the crucial function. A student has decided on a class (by name) and wants to sign up. The <tt class="docutils literal"><span class="pre">signup</span></tt> function will take a student (<tt class="docutils literal"><span class="pre">s</span></tt>) and a class (<tt class="docutils literal"><span class="pre">c</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>We simply insert the appropriate record (with a blank value).</p>
</div>
<div class="section" id="dropping-a-class">
<h3>Dropping a class<a class="headerlink" href="#dropping-a-class" title="Permalink to this headline">∞</a></h3>
<p>Dropping a class is similar to signing up:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
</pre></div>
</div>
<p>Of course, to actually drop the student from the class, we need to be able to delete a record from the database.  We do this with the <tt class="docutils literal"><span class="pre">del</span> <span class="pre">tr[key]</span></tt> syntax.</p>
</div>
<div class="section" id="done">
<h3>Done?<a class="headerlink" href="#done" title="Permalink to this headline">∞</a></h3>
<p>We report back to the project leader that our application is done&#8212;students can sign up for, drop, and list classes. Unfortunately, we learn that there has been a bit of scope creep in the mean time. Popular classes are getting over-subscribed, and our application is going to need to enforce the class size constraint as students add and drop classes.</p>
</div>
<div class="section" id="seats-are-limited">
<h3>Seats are limited!<a class="headerlink" href="#seats-are-limited" title="Permalink to this headline">∞</a></h3>
<p>Let&#8217;s go back to the data model. Remember that we stored the number of seats in the class in the value of the key-value entry in the class list. Let&#8217;s refine that a bit to track the <em>remaining</em> number of seats in the class. The initialization can work the same way. (In our example, all classes initially have 100 seats), but the <tt class="docutils literal"><span class="pre">available_classes</span></tt>, <tt class="docutils literal"><span class="pre">signup</span></tt>, and <tt class="docutils literal"><span class="pre">drop</span></tt> functions are going to have to change. Let&#8217;s start with <tt class="docutils literal"><span class="pre">available_classes</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">available_classes</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">fdb</span><span class="o">.</span><span class="n">tuple</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">range</span><span class="p">(())]</span>
<span class="hll">            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
</span></pre></div>
</div>
<p>This is easy &#8211; we simply add a condition to check that the value is non-zero. Let&#8217;s check out <tt class="docutils literal"><span class="pre">signup</span></tt> next:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
<span class="hll">    <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">present</span><span class="p">():</span> <span class="k">return</span>  <span class="c"># already signed up</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">seats_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))])</span>
</span><span class="hll">    <span class="k">if</span> <span class="ow">not</span> <span class="n">seats_left</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No remaining seats&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">seats_left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span>    <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>We now have to check that we aren&#8217;t already signed up, since we don&#8217;t want a double sign up to decrease the number of seats twice. Then we look up how many seats are left to make sure there is a seat remaining so we don&#8217;t push the counter into the negative. If there is a seat remaining, we decrement the counter.</p>
</div>
<div class="section" id="concurrency-and-consistency">
<h3>Concurrency and consistency<a class="headerlink" href="#concurrency-and-consistency" title="Permalink to this headline">∞</a></h3>
<p>The <tt class="docutils literal"><span class="pre">signup</span></tt> function is starting to get a bit complex; it now reads and writes a few different key-value pairs in the database. One of the tricky issues in this situation is what happens as multiple clients/students read and modify the database at the same time. Couldn&#8217;t two students both see one remaining seat and sign up at the same time?</p>
<p>These are tricky issues without simple answers&#8212;unless you have transactions! Because these functions are defined as FoundationDB transactions, we can have a simple answer: Each transactional function behaves as if it is the only one modifying the database. There is no way for a transaction to &#8216;see&#8217; another transaction change the database, and each transaction ensures that either all of its modifications occur or none of them do.</p>
<p>Looking deeper, it is, of course, possible for two transactions to conflict. For example, if two people both see a class with one seat and sign up at the same time, FoundationDB must allow only one to succeed. This causes one of the transactions to fail to commit (which can also be caused by network outages, crashes, etc.). To ensure correct operation, applications need to handle this situation, usually via retrying the transaction. In this case, the conflicting transaction will be retried automatically by the <tt class="docutils literal"><span class="pre">&#64;fdb.transactional</span></tt> decorator and will eventually lead to the correct result, a &#8216;No remaining seats&#8217; exception.</p>
</div>
<div class="section" id="idempotence">
<h3>Idempotence<a class="headerlink" href="#idempotence" title="Permalink to this headline">∞</a></h3>
<p>Occasionally, a transaction might be retried even after it succeeds (for example, if the client loses contact with the cluster at just the wrong moment). This can cause problems if transactions are not written to be idempotent, i.e. to have the same effect if committed twice as if committed once. There are generic design patterns for <a class="reference internal" href="developer-guide.html#developer-guide-unknown-results"><em>making any transaction idempotent</em></a>, but many transactions are naturally idempotent. For example, all of the transactions in this tutorial are idempotent.</p>
</div>
<div class="section" id="dropping-with-limited-seats">
<h3>Dropping with limited seats<a class="headerlink" href="#dropping-with-limited-seats" title="Permalink to this headline">∞</a></h3>
<p>Let&#8217;s finish up the limited seats feature by modifying the drop function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
<span class="hll">    <span class="k">if</span> <span class="ow">not</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">present</span><span class="p">():</span> <span class="k">return</span>  <span class="c"># not taking this class</span>
</span><span class="hll">    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span>    <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>
</pre></div>
</div>
<p>This case is easier than signup because there are no constraints we can hit. We just need to make sure the student is in the class and to &#8220;give back&#8221; one seat when the student drops.</p>
</div>
<div class="section" id="more-features">
<h3>More features?!<a class="headerlink" href="#more-features" title="Permalink to this headline">∞</a></h3>
<p>Of course, as soon as our new version of the system goes live, we hear of a trick that certain students are using. They are signing up for all classes immediately, and only later dropping those that they don&#8217;t want to take. This has led to an unusable system, and we have been asked to fix it. We decide to limit students to five classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">present</span><span class="p">():</span> <span class="k">return</span>  <span class="c"># already signed up</span>

    <span class="n">seats_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">seats_left</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No remaining seats&#39;</span><span class="p">)</span>

<span class="hll">    <span class="n">classes</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="n">attends</span><span class="o">.</span><span class="n">range</span><span class="p">((</span><span class="n">s</span><span class="p">,))]</span>
</span><span class="hll">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Too many classes&#39;</span><span class="p">)</span>
</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">seats_left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
<p>Fortunately, we decided on a data model that keeps all of the attending records for a single student together. With this approach, we can use a single range read in the <tt class="docutils literal"><span class="pre">attends</span></tt> subspace to retrieve all the classes that a student is signed up for. We simply throw an exception if the number of classes has reached the limit of five.</p>
</div>
<div class="section" id="composing-transactions">
<h3>Composing transactions<a class="headerlink" href="#composing-transactions" title="Permalink to this headline">∞</a></h3>
<p>Oh, just one last feature, we&#8217;re told. We have students that are trying to switch from one popular class to another. By the time they drop one class to free up a slot for themselves, the open slot in the other class is gone. By the time they see this and try to re-add their old class, that slot is gone too! So, can we make it so that a student can switch from one class to another without this worry?</p>
<p>Fortunately, we have FoundationDB, and this sounds an awful lot like the transactional property of atomicity&#8212;the all-or-nothing behavior that we already rely on. All we need to do is to <em>compose</em> the <tt class="docutils literal"><span class="pre">drop</span></tt> and <tt class="docutils literal"><span class="pre">signup</span></tt> functions into a new <tt class="docutils literal"><span class="pre">switch</span></tt> function. This makes the <tt class="docutils literal"><span class="pre">switch</span></tt> function exceptionally easy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">old_c</span><span class="p">,</span> <span class="n">new_c</span><span class="p">):</span>
    <span class="n">drop</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">old_c</span><span class="p">)</span>
    <span class="n">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_c</span><span class="p">)</span>
</pre></div>
</div>
<p>The simplicity of this implementation belies the sophistication of what FoundationDB is taking care of for us.</p>
<p>By dropping the old class and signing up for the new one inside a single transaction, we ensure that either both steps happen, or that neither happens. The first notable thing about the <tt class="docutils literal"><span class="pre">switch</span></tt> function is that it is transactionally decorated, but it also calls the transactionally decorated functions <tt class="docutils literal"><span class="pre">signup</span></tt> and <tt class="docutils literal"><span class="pre">drop</span></tt>. Because these decorated functions can accept either a database or an existing transaction as the <tt class="docutils literal"><span class="pre">tr</span></tt> argument, the switch function can be called with a database by a simple client, and a new transaction will be automatically created. However, once this transaction is created and passed in as <tt class="docutils literal"><span class="pre">tr</span></tt>, the calls to <tt class="docutils literal"><span class="pre">drop</span></tt> and <tt class="docutils literal"><span class="pre">signup</span></tt> both share the same <tt class="docutils literal"><span class="pre">tr</span></tt>. This ensures that they see each other&#8217;s modifications to the database, and all of the changes that both of them make in sequence are made transactionally when the switch function returns. This compositional capability is very powerful.</p>
<p>Also note that, if an exception is raised, for example, in <tt class="docutils literal"><span class="pre">signup</span></tt>, the exception is not caught by <tt class="docutils literal"><span class="pre">switch</span></tt> and so will be thrown to the calling function. In this case, the transaction object (owned by the decorator) is destroyed, automatically rolling back all database modifications, leaving the database completely unchanged by the half-executed function.</p>
</div>
<div class="section" id="are-we-done">
<h3>Are we done?<a class="headerlink" href="#are-we-done" title="Permalink to this headline">∞</a></h3>
<p>Yep, we&#8217;re done. Fortunately, our UI team built an awesome UI while we were working on our back end, and we are ready to deploy. If you want to see this entire application in one place plus some multithreaded testing code to simulate concurrency, look at the <a class="reference internal" href="#tutorial-appendix"><em>Appendix: SchedulingTutorial.py</em></a>, below.</p>
</div>
<div class="section" id="deploying-and-scaling">
<h3>Deploying and scaling<a class="headerlink" href="#deploying-and-scaling" title="Permalink to this headline">∞</a></h3>
<p>Since we store all state for this application in FoundationDB, deploying and scaling this solution up is impressively painless. Just run a web server, the UI, this back end, and point the whole thing at FoundationDB. We can run as many computers with this setup as we want, and they can all hit the database at the same time because of the transactional integrity of FoundationDB. Also, since all of the state in the system is stored in the database, any of these computers can fail without any lasting consequences.</p>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">∞</a></h2>
<ul class="simple">
<li>See <a class="reference internal" href="data-modeling.html"><em>Data Modeling</em></a> for guidance on using tuple and subspaces to enable effective storage and retrieval of data.</li>
<li>See <a class="reference internal" href="developer-guide.html"><em>Developer Guide</em></a> for general guidance on development using FoundationDB.</li>
<li>See the <a class="reference internal" href="api-reference.html"><em>API References</em></a> for detailed API documentation.</li>
</ul>
</div>
<div class="section" id="appendix-schedulingtutorial-py">
<span id="tutorial-appendix"></span><h2>Appendix: SchedulingTutorial.py<a class="headerlink" href="#appendix-schedulingtutorial-py" title="Permalink to this headline">∞</a></h2>
<p>Here&#8217;s the code for the scheduling tutorial:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">fdb</span>

<span class="n">fdb</span><span class="o">.</span><span class="n">api_version</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>


<span class="c">####################################</span>
<span class="c">##        Initialization          ##</span>
<span class="c">####################################</span>

<span class="c"># Data model:</span>
<span class="c"># (&#39;attends&#39;, student, class) = &#39;&#39;</span>
<span class="c"># (&#39;class&#39;, class_name) = seats_left</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">scheduling</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">directory</span><span class="o">.</span><span class="n">create_or_open</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;scheduling&#39;</span><span class="p">,))</span>
<span class="n">course</span> <span class="o">=</span> <span class="n">scheduling</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span>
<span class="n">attends</span> <span class="o">=</span> <span class="n">scheduling</span><span class="p">[</span><span class="s">&#39;attends&#39;</span><span class="p">]</span>

<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">add_class</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="c"># Generate 1,620 classes like &#39;9:00 chem for dummies&#39;</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;intro&#39;</span><span class="p">,</span> <span class="s">&#39;for dummies&#39;</span><span class="p">,</span> <span class="s">&#39;remedial&#39;</span><span class="p">,</span> <span class="s">&#39;101&#39;</span><span class="p">,</span>
          <span class="s">&#39;201&#39;</span><span class="p">,</span> <span class="s">&#39;301&#39;</span><span class="p">,</span> <span class="s">&#39;mastery&#39;</span><span class="p">,</span> <span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;seminar&#39;</span><span class="p">]</span>
<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;chem&#39;</span><span class="p">,</span> <span class="s">&#39;bio&#39;</span><span class="p">,</span> <span class="s">&#39;cs&#39;</span><span class="p">,</span> <span class="s">&#39;geometry&#39;</span><span class="p">,</span> <span class="s">&#39;calc&#39;</span><span class="p">,</span>
         <span class="s">&#39;alg&#39;</span><span class="p">,</span> <span class="s">&#39;film&#39;</span><span class="p">,</span> <span class="s">&#39;music&#39;</span><span class="p">,</span> <span class="s">&#39;art&#39;</span><span class="p">,</span> <span class="s">&#39;dance&#39;</span><span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:00&#39;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>
<span class="n">class_combos</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">class_combos</span><span class="p">]</span>

<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">scheduling</span><span class="o">.</span><span class="n">range</span><span class="p">(())]</span>  <span class="c"># Clear the directory</span>
    <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
        <span class="n">add_class</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>


<span class="c">####################################</span>
<span class="c">##  Class Scheduling Functions    ##</span>
<span class="c">####################################</span>


<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">available_classes</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">range</span><span class="p">(())]</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>


<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">present</span><span class="p">():</span> <span class="k">return</span>  <span class="c"># already signed up</span>

    <span class="n">seats_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">seats_left</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No remaining seats&#39;</span><span class="p">)</span>

    <span class="n">classes</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="n">attends</span><span class="o">.</span><span class="n">range</span><span class="p">((</span><span class="n">s</span><span class="p">,))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Too many classes&#39;</span><span class="p">)</span>

    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">seats_left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>


<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">attends</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span><span class="o">.</span><span class="n">present</span><span class="p">():</span> <span class="k">return</span>  <span class="c"># not taking this class</span>
    <span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">pack</span><span class="p">((</span><span class="n">c</span><span class="p">,))])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span>


<span class="nd">@fdb.transactional</span>
<span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">old_c</span><span class="p">,</span> <span class="n">new_c</span><span class="p">):</span>
    <span class="n">drop</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">old_c</span><span class="p">)</span>
    <span class="n">signup</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_c</span><span class="p">)</span>

<span class="c">####################################</span>
<span class="c">##           Testing              ##</span>
<span class="c">####################################</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">indecisive_student</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span>
    <span class="n">student_ID</span> <span class="o">=</span> <span class="s">&#39;s{:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">all_classes</span> <span class="o">=</span> <span class="n">class_names</span>
    <span class="n">my_classes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">class_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_classes</span><span class="p">)</span>
        <span class="n">moods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">class_count</span><span class="p">:</span> <span class="n">moods</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;drop&#39;</span><span class="p">,</span> <span class="s">&#39;switch&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">class_count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">moods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;add&#39;</span><span class="p">)</span>
        <span class="n">mood</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">moods</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_classes</span><span class="p">:</span>
                <span class="n">all_classes</span> <span class="o">=</span> <span class="n">available_classes</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mood</span> <span class="o">==</span> <span class="s">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_classes</span><span class="p">)</span>
                <span class="n">signup</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">student_ID</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">my_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mood</span> <span class="o">==</span> <span class="s">&#39;drop&#39;</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">my_classes</span><span class="p">)</span>
                <span class="n">drop</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">student_ID</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">my_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mood</span> <span class="o">==</span> <span class="s">&#39;switch&#39;</span><span class="p">:</span>
                <span class="n">old_c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">my_classes</span><span class="p">)</span>
                <span class="n">new_c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_classes</span><span class="p">)</span>
                <span class="n">switch</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">student_ID</span><span class="p">,</span> <span class="n">old_c</span><span class="p">,</span> <span class="n">new_c</span><span class="p">)</span>
                <span class="n">my_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_c</span><span class="p">)</span>
                <span class="n">my_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_c</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span><span class="p">,</span> <span class="s">&quot;Need to recheck available classes.&quot;</span>
            <span class="n">all_classes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">ops_per_student</span><span class="p">):</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">indecisive_student</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ops_per_student</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">students</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">thr</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span> <span class="n">thr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">thr</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span> <span class="n">thr</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&quot;Ran&quot;</span><span class="p">,</span> <span class="n">students</span> <span class="o">*</span> <span class="n">ops_per_student</span><span class="p">,</span> <span class="s">&quot;transactions&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">init</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;initialized&quot;</span>
    <span class="n">run</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


  </div>
  <div id="search-documentation">
    <form action="search.html" method="get">
      <input type="text" name="q" class="search-query" placeholder="Search Documentation" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <div id="docs-page-nav">
      <h3>Navigate this page</h3>
      <ul><li><a class="reference internal" href="#">Class Scheduling</a><ul><li><a class="reference internal" href="#first-steps">First steps</a></li><li><a class="reference internal" href="#class-scheduling-application">Class scheduling application</a><ul><li><a class="reference internal" href="#requirements">Requirements</a></li><li><a class="reference internal" href="#data-model">Data model</a></li><li><a class="reference internal" href="#directories-and-subspaces">Directories and Subspaces</a></li><li><a class="reference internal" href="#transactions">Transactions</a></li><li><a class="reference internal" href="#making-some-sample-classes">Making some sample classes</a></li><li><a class="reference internal" href="#initializing-the-database">Initializing the database</a></li><li><a class="reference internal" href="#listing-available-classes">Listing available classes</a></li><li><a class="reference internal" href="#signing-up-for-a-class">Signing up for a class</a></li><li><a class="reference internal" href="#dropping-a-class">Dropping a class</a></li><li><a class="reference internal" href="#done">Done?</a></li><li><a class="reference internal" href="#seats-are-limited">Seats are limited!</a></li><li><a class="reference internal" href="#concurrency-and-consistency">Concurrency and consistency</a></li><li><a class="reference internal" href="#idempotence">Idempotence</a></li><li><a class="reference internal" href="#dropping-with-limited-seats">Dropping with limited seats</a></li><li><a class="reference internal" href="#more-features">More features?!</a></li><li><a class="reference internal" href="#composing-transactions">Composing transactions</a></li><li><a class="reference internal" href="#are-we-done">Are we done?</a></li><li><a class="reference internal" href="#deploying-and-scaling">Deploying and scaling</a></li></ul></li><li><a class="reference internal" href="#next-steps">Next steps</a></li><li><a class="reference internal" href="#appendix-schedulingtutorial-py">Appendix: SchedulingTutorial.py</a></li></ul></li></ul>
    </div>
    <div id="docs-global-nav">
      <h3>Navigate All Docs</h3>
    </div>
  </div>
</div>


</div>
<footer id='footer'>
<div class='container'>
<ul>
<li>
<h3>Get Help</h3>
<ul id='get-help-list'>
<li><a href=../../contact/index.html>Contact Us</a></li>
</ul>
</li>
<li>
<h3>Social</h3>
<ul>
<li><a href=../../https:/web.archive.org/web/20150325003227/https:/twitter.com/foundationdb>Twitter</a></li>
</ul>
</li>
<li>
<h3>Legal</h3>
<ul>
<li><a href=../../legal/privacy/index.html>Privacy Policy</a></li>
<li><a href=../../files/TermsOfService.pdf>Terms of Service</a></li>
<li><a href=../../legal/trademark/index.html>Trademark Disclaimer</a></li>
</ul>
</li>
</ul>
</div>
<div id='copyright'>&copy; 2015 FoundationDB</div>
</footer>
<div class='modal' id='login-modal'>
<div class='cover'></div>
<div class='inner'>
<h2>FoundationDB Log In</h2>
<div class='content'>
<div id='explanation'></div>
<form>
<fieldset>
<div class='errors'></div>
<ul>
<li>
<label for="email">Email Address</label>
<input id='email' type='email' value=''>
</li>
<li>
<label for="password">Password</label>
<input id='password' type='password'>
</li>
<li class='actions'>
<button>
Log In
<span class='spinner'></span>
</button>
<a href="#signup">Need an account?</a>
<a href="#reset-password" id="login-reset-link">Need to reset your password?</a>
</li>
</ul>
</fieldset>
</form>
</div>
<a class='close' href='#close'>
<i class='icon-cancel'></i>
</a>
</div>
</div>
<div class='modal' id='reset-password-modal'>
<div class='cover'></div>
<div class='inner'>
<h2>Reset Your Password</h2>
<div class='content'>
<form>
<p class='note'>Enter your email address below and we'll send you password reset instructions.</p>
<fieldset>
<div class='errors'></div>
<ul>
<li>
<label for="email">Email Address</label>
<input autocapitalize="false" id="email" name="email" type="email" value="" />
</li>
<li class='actions'>
<button>
Send Instructions
<span class='spinner'></span>
</button>
<a href="#cancel">Cancel</a>
</li>
</ul>
</fieldset>
</form>
<div id='done'>
<p>Please check your email. Your password reset instructions have been emailed to you.</p>
</div>
</div>
<a class='close' href='#close'>
<i class='icon-cancel'></i>
</a>
</div>
</div>
<div class='modal' id='video-modal'>
<div class='cover'></div>
<div class='inner'>
<iframe></iframe>
<a class='close' href='#close'>
<i class='icon-cancel'></i>
</a>
</div>
</div>

<script src=../../js_/application-a7f51eff68dda15563d95dd6b13ee7ae.js type="text/javascript"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
<![endif]-->

</body>
</html>





<!--
     FILE ARCHIVED ON 0:32:27 Mar 25, 2015 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 10:30:10 Sep 23, 2016.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
